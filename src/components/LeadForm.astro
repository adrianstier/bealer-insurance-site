---
interface Props {
  insuranceType?: string;
  heading?: string;
  subheading?: string;
}

const {
  insuranceType = "",
  heading = "Get Your Free Quote Today",
  subheading = "Connect with a local Goleta insurance agent in minutes"
} = Astro.props;

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || 'https://bzjssogezdnybbenqygq.supabase.co';

const insuranceOptions = [
  { value: "auto", label: "Auto Insurance" },
  { value: "home", label: "Home Insurance" },
  { value: "renters", label: "Renters Insurance" },
  { value: "business", label: "Business Insurance" },
  { value: "life", label: "Life Insurance" },
  { value: "other", label: "Other" },
];
---

<section id="quote-form" class="py-16 bg-gray-50">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">{heading}</h2>
        <p class="text-gray-600">{subheading}</p>
      </div>

      <form id="lead-form" class="space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <!-- First Name -->
          <div>
            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
              First Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              required
              autocomplete="given-name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="John"
            />
          </div>

          <!-- Last Name -->
          <div>
            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
              Last Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="lastName"
              name="lastName"
              required
              autocomplete="family-name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="Smith"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              inputmode="email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="john@example.com"
            />
          </div>

          <!-- Phone -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
              Phone <span class="text-red-500">*</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              autocomplete="tel"
              inputmode="tel"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="(805) 555-0123"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <!-- Insurance Type -->
          <div>
            <label for="insuranceType" class="block text-sm font-medium text-gray-700 mb-1">
              Insurance Type <span class="text-red-500">*</span>
            </label>
            <select
              id="insuranceType"
              name="insuranceType"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white"
            >
              <option value="">Select insurance type</option>
              {insuranceOptions.map((option) => (
                <option value={option.value} selected={insuranceType === option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          <!-- Zip Code -->
          <div>
            <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-1">
              Zip Code <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="zipCode"
              name="zipCode"
              required
              pattern="[0-9]{5}"
              inputmode="numeric"
              maxlength="5"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
              placeholder="93117"
            />
          </div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          id="submit-btn"
          class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Get Connected with a Local Agent
        </button>

        <!-- Privacy Notice -->
        <p class="text-xs text-gray-500 text-center">
          By submitting this form, you agree to our
          <a href="/privacy" class="text-blue-600 hover:underline">Privacy Policy</a>.
          We'll connect you with a licensed local agent who can help with your insurance needs.
        </p>
      </form>

      <!-- Success Message (Hidden by default) -->
      <div id="success-message" class="hidden text-center py-8">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">Thank You!</h3>
        <p class="text-gray-600">
          A local Goleta insurance agent will contact you within 24 hours.
        </p>
      </div>

      <!-- Error Message (Hidden by default) -->
      <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
        <div class="flex items-center gap-2 text-red-800">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
          <span class="font-medium">Something went wrong. Please try again or call us directly.</span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('lead-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  // Phone formatting
  const phoneInput = document.getElementById('phone') as HTMLInputElement;
  phoneInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    let value = target.value.replace(/\D/g, '');
    if (value.length >= 6) {
      value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
    } else if (value.length >= 3) {
      value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
    }
    target.value = value;
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    errorMessage?.classList.add('hidden');

    const formData = new FormData(form);
    const data = {
      firstName: formData.get('firstName'),
      lastName: formData.get('lastName'),
      email: formData.get('email'),
      phone: formData.get('phone'),
      insuranceType: formData.get('insuranceType'),
      zipCode: formData.get('zipCode'),
      source: window.location.pathname,
      timestamp: new Date().toISOString()
    };

    try {
      const response = await fetch('https://bzjssogezdnybbenqygq.supabase.co/functions/v1/submit-lead', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error('Failed to submit');
      }

      // Track conversion in GA4
      if (typeof gtag !== 'undefined') {
        gtag('event', 'generate_lead', {
          'event_category': 'form',
          'event_label': data.insuranceType,
          'value': 1
        });
      }

      // Show success message
      form.classList.add('hidden');
      successMessage?.classList.remove('hidden');

    } catch (error) {
      console.error('Form submission error:', error);
      errorMessage?.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Get Connected with a Local Agent';
    }
  });
</script>
