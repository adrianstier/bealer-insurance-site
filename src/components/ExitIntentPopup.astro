---
// Exit intent popup - captures visitors about to leave
---

<div id="exit-popup" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="exit-popup-backdrop"></div>

  <!-- Modal -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden transform scale-95 opacity-0 transition-all duration-300" id="exit-popup-modal">
      <!-- Close button -->
      <button id="exit-popup-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Urgency header -->
      <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4 text-white">
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          <span class="font-bold">WAIT! Before You Go...</span>
        </div>
      </div>

      <div class="p-6 md:p-8">
        <h3 class="text-2xl md:text-3xl font-bold text-gray-900 mb-3">
          Don't Miss Out on <span class="text-green-600">$547</span> in Savings!
        </h3>
        <p class="text-gray-600 mb-6">
          805 residents are saving an average of $547/year by comparing quotes. Get your free quote in 60 seconds - no obligation.
        </p>

        <!-- Quick 3-field form -->
        <form id="exit-form" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <input
              type="text"
              name="firstName"
              required
              placeholder="First Name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
            />
            <input
              type="tel"
              name="phone"
              required
              placeholder="Phone Number"
              inputmode="tel"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
            />
          </div>
          <input
            type="email"
            name="email"
            placeholder="Email (optional)"
            inputmode="email"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
          />
          <button
            type="submit"
            class="w-full bg-green-600 text-white py-4 px-6 rounded-lg text-lg font-bold hover:bg-green-700 transition-colors shadow-lg"
          >
            Yes! Get My Free Quote Now
          </button>
        </form>

        <button id="exit-popup-decline" class="w-full mt-3 text-sm text-gray-500 hover:text-gray-700 py-2">
          Maybe later
        </button>

        <!-- Trust signals -->
        <div class="flex items-center justify-center gap-4 mt-6 pt-4 border-t border-gray-100">
          <div class="flex items-center gap-1 text-sm text-gray-500">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span>Secure</span>
          </div>
          <div class="flex items-center gap-1 text-sm text-gray-500">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span>No Spam</span>
          </div>
          <div class="flex items-center gap-1 text-sm text-gray-500">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span>100% Free</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="exit-success" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-2">You're All Set!</h3>
      <p class="text-gray-600 mb-6">A local agent will contact you within 24 hours with your personalized quotes.</p>
      <button id="exit-success-close" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
        Continue Browsing
      </button>
    </div>
  </div>
</div>

<script>
  const exitPopup = document.getElementById('exit-popup');
  const exitPopupModal = document.getElementById('exit-popup-modal');
  const exitPopupClose = document.getElementById('exit-popup-close');
  const exitPopupBackdrop = document.getElementById('exit-popup-backdrop');
  const exitPopupDecline = document.getElementById('exit-popup-decline');
  const exitForm = document.getElementById('exit-form') as HTMLFormElement;
  const exitSuccess = document.getElementById('exit-success');
  const exitSuccessClose = document.getElementById('exit-success-close');

  let hasShownPopup = false;
  let hasScrolled = false;

  // Show popup on exit intent (desktop) or scroll up (mobile)
  function showExitPopup() {
    if (hasShownPopup || sessionStorage.getItem('exitPopupShown')) return;
    hasShownPopup = true;
    sessionStorage.setItem('exitPopupShown', 'true');

    exitPopup?.classList.remove('hidden');
    setTimeout(() => {
      exitPopupModal?.classList.remove('scale-95', 'opacity-0');
      exitPopupModal?.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  function hideExitPopup() {
    exitPopupModal?.classList.add('scale-95', 'opacity-0');
    exitPopupModal?.classList.remove('scale-100', 'opacity-100');
    setTimeout(() => exitPopup?.classList.add('hidden'), 200);
  }

  // Desktop: mouse leaves viewport at top
  document.addEventListener('mouseout', (e) => {
    if (e.clientY <= 0 && !hasShownPopup) {
      showExitPopup();
    }
  });

  // Mobile: detect scroll up after scrolling down
  let lastScrollY = window.scrollY;
  window.addEventListener('scroll', () => {
    if (window.scrollY > 500) hasScrolled = true;

    if (hasScrolled && window.scrollY < lastScrollY - 100 && window.scrollY < 200) {
      showExitPopup();
    }
    lastScrollY = window.scrollY;
  });

  // Also show after 45 seconds if user hasn't converted
  setTimeout(() => {
    if (!document.querySelector('#success-message:not(.hidden)')) {
      showExitPopup();
    }
  }, 45000);

  // Close handlers
  exitPopupClose?.addEventListener('click', hideExitPopup);
  exitPopupBackdrop?.addEventListener('click', hideExitPopup);
  exitPopupDecline?.addEventListener('click', hideExitPopup);
  exitSuccessClose?.addEventListener('click', () => {
    exitSuccess?.classList.add('hidden');
  });

  // Form submission
  exitForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(exitForm);

    const data = {
      firstName: formData.get('firstName'),
      lastName: '',
      email: formData.get('email'),
      phone: formData.get('phone'),
      insuranceType: 'general',
      zipCode: '93117',
      source: window.location.pathname + ' (exit popup)',
      timestamp: new Date().toISOString()
    };

    try {
      await fetch('https://bzjssogezdnybbenqygq.supabase.co/functions/v1/submit-lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (typeof gtag !== 'undefined') {
        gtag('event', 'generate_lead', {
          'event_category': 'exit_popup',
          'event_label': 'exit_intent',
          'value': 1
        });
      }

      hideExitPopup();
      setTimeout(() => {
        exitSuccess?.classList.remove('hidden');
      }, 300);
    } catch (error) {
      console.error('Exit form error:', error);
    }
  });
</script>
